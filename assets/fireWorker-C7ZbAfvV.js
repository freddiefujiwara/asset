(function(){"use strict";function q(n,o){let s=0;if(n>=60){const m=Math.min(60,o),t=892252+Math.max(0,m-44)*42e3;s+=533520+t*.76}return n>=62&&(s+=78e4),Math.round(s/12)}function Q(){let n=0,o=0;for(;n===0;)n=Math.random();for(;o===0;)o=Math.random();return Math.sqrt(-2*Math.log(n))*Math.cos(2*Math.PI*o)}function X({monthlyExpense:n,monthlyReturn:o,monthlyInflation:s,remainingMonths:i,taxRate:m,includeTax:e,currentAgeInSimulation:t,includePension:a=!0,withdrawalRate:r=.04}){if(i<=0)return 0;const h=o,l=s,M=r/12,u=e?m:0;let E=0;for(let _=i-1;_>=0;_--){const C=t+_/12,R=a?q(C,t):0,N=n*Math.pow(1+l,_),d=Math.max(0,N-R),v=E/(1+h)+d/(1-u),D=(E/(1+h)-R/(1-u))/(1-M/(1-u));E=Math.max(v,D)}return Math.max(0,E)}function Z(n){return`${n.getFullYear()}-${String(n.getMonth()+1).padStart(2,"0")}`}function tt({baseMonthlyExpense:n,monthlyInflationRate:o,monthIndex:s,simulationStartDate:i,mortgageMonthlyPayment:m,mortgagePayoffDate:e}){const t=m||0,r=Math.max(0,n-t)*Math.pow(1+o,s);if(!t||!e)return r+t;const h=new Date(i);return h.setMonth(h.getMonth()+s),Z(h)>e?r:r+t}function w(n,{recordMonthly:o=!1,fireMonth:s=-1,returnsArray:i=null,randomReturn:m=!1}={}){const{initialAssets:e,riskAssets:t,annualReturnRate:a,annualStandardDeviation:r,monthlyExpense:h,monthlyExpenses:l,monthlyIncome:M=0,currentAge:u=40,maxMonths:E=1200,includeInflation:_=!1,inflationRate:C=.02,includeTax:R=!1,taxRate:N=.20315,withdrawalRate:d=.04,mortgageMonthlyPayment:v=0,mortgagePayoffDate:D=null,postFireExtraExpense:st=0,includePension:B=!1,monthlyInvestment:at=0}=n,rt=h??(l?l/12:0),lt=Math.pow(1+a,1/12)-1,k=Math.pow(1+(_?C:0),1/12)-1,L=(100-u)*12,ct=new Date;let c=t,A=e-t,x=s;const p=o?[]:null,it=L;for(let f=0;f<=it;f++){const G=u+f/12,ut=Math.max(0,L-f),W=tt({baseMonthlyExpense:rt,monthlyInflationRate:k,monthIndex:f,simulationStartDate:ct,mortgageMonthlyPayment:v,mortgagePayoffDate:D}),V=st*Math.pow(1+k,f),$=Math.max(0,A+c),y=x!==-1&&f>=x,mt=x===-1?u+100:u+x/12,H=B?q(G,mt):0,j=y?0:M,O=W+(y?V:0),b=j+H;if(o&&f<=E){const S=X({monthlyExpense:W+V,monthlyReturn:lt,monthlyInflation:k,remainingMonths:ut,taxRate:N,includeTax:R,currentAgeInSimulation:G,includePension:B,withdrawalRate:d});p.push({month:f,age:G,assets:$,riskAssets:c,cashAssets:A,requiredAssets:S,isFire:y,income:j,pension:H,expenses:O,investmentGain:0,withdrawal:0})}if(f===L)break;let P=0,K=0,Y=0;const Mt=i[f];if(y){const S=$*d/12,g=Math.max(0,O-b),U=Math.max(g,S),F=Math.min(A,U),I=U-F,T=Math.max(0,c*(R?1-N:1)),z=Math.min(I,T),J=z/(R?1-N:1);c-=J,c=Math.max(0,c),A+=b+z-O,P=F+J}else{const S=b-O,g=A+S;if(g<0){const U=Math.abs(g),F=Math.max(0,c*(R?1-N:1)),I=Math.min(U,F),T=I/(R?1-N:1);c-=T,c=Math.max(0,c),A=g+I,P=I>0?T:0}else K=Math.min(at,g),A=g-K,c+=K,P=0}if(Y=c*Mt,c+=Y,o&&f<=E){const S=p[p.length-1];S&&(S.investmentGain=Y,S.withdrawal=P)}}const ht=A+c>=0;return{fireReachedMonth:x,monthlyData:p,survived:ht}}function nt(n,o=null){const{currentAge:s=40,maxMonths:i=1200}=n,m=Math.min(i,(100-s)*12);let e=-1;for(let t=0;t<=m;t+=12)if(w(n,{fireMonth:t,returnsArray:o}).survived){e=t;break}if(e!==-1){let t=Math.max(0,e-11),a=e;for(;t<=a;){const r=Math.floor((t+a)/2);w(n,{fireMonth:r,returnsArray:o}).survived?(e=r,a=r-1):t=r+1}}return e}function et(n,o={}){const{forceFireMonth:s=null,returnsArray:i=null,randomReturn:m=!1,recordMonthly:e=!1}=o;let t=i;if(!t){const{currentAge:r=40,annualReturnRate:h=0,annualStandardDeviation:l=0}=n,M=(100-r)*12,u=Math.pow(1+h,1/12)-1,E=l/Math.sqrt(12);t=[];for(let _=0;_<=M;_++)m?t.push(u+E*Q()):t.push(u)}let a=s;return a===null&&(a=nt(n,t)),w(n,{recordMonthly:e,fireMonth:a,returnsArray:t})}function ot(n){const{currentAge:o=40,maxMonths:s=1200}=n,i=n.iterations??1e3,m=Math.min(s,(100-o)*12),e=[];for(let l=0;l<i;l++){const M=et(n,{randomReturn:!0}),u=M.fireReachedMonth===-1?m:M.fireReachedMonth;e.push(u)}e.sort((l,M)=>l-M);const t=e[Math.floor(e.length/2)],a=e[Math.floor(e.length*.05)],r=e[Math.floor(e.length*.95)],h=e.reduce((l,M)=>l+M,0)/e.length;return{trials:e,stats:{mean:h,median:t,p5:a,p95:r}}}self.onmessage=n=>{const o=n.data;try{const s=ot(o);self.postMessage({type:"success",result:s})}catch(s){self.postMessage({type:"error",error:s.message})}}})();
