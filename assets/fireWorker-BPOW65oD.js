(function(){"use strict";function q(t,o){let s=0;if(t>=60){const M=Math.min(60,o),e=892252+Math.max(0,M-44)*42e3;s+=533520+e*.76}return t>=62&&(s+=78e4),Math.round(s/12)}function Q(){let t=0,o=0;for(;t===0;)t=Math.random();for(;o===0;)o=Math.random();return Math.sqrt(-2*Math.log(t))*Math.cos(2*Math.PI*o)}function X({monthlyExpense:t,monthlyReturn:o,monthlyInflation:s,remainingMonths:h,taxRate:M,includeTax:n,currentAgeInSimulation:e,includePension:l=!0,withdrawalRate:a=.04}){if(h<=0)return 0;const c=o,r=s,u=a/12,m=n?M:0;let E=0;for(let _=h-1;_>=0;_--){const C=e+_/12,R=l?q(C,e):0,N=t*Math.pow(1+r,_),d=Math.max(0,N-R),v=E/(1+c)+d/(1-m),D=(E/(1+c)-R/(1-m))/(1-u/(1-m));E=Math.max(v,D)}return Math.max(0,E)}function Z(t){return`${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}`}function tt({baseMonthlyExpense:t,monthlyInflationRate:o,monthIndex:s,simulationStartDate:h,mortgageMonthlyPayment:M,mortgagePayoffDate:n}){const e=M||0,a=Math.max(0,t-e)*Math.pow(1+o,s);if(!e||!n)return a+e;const c=new Date(h);return c.setMonth(c.getMonth()+s),Z(c)>n?a:a+e}function T(t,{recordMonthly:o=!1,fireMonth:s=-1,returnsArray:h=null,randomReturn:M=!1}={}){const{initialAssets:n,riskAssets:e,annualReturnRate:l,annualStandardDeviation:a,monthlyExpense:c,monthlyExpenses:r,monthlyIncome:u=0,currentAge:m=40,maxMonths:E=1200,includeInflation:_=!1,inflationRate:C=.02,includeTax:R=!1,taxRate:N=.20315,withdrawalRate:d=.04,mortgageMonthlyPayment:v=0,mortgagePayoffDate:D=null,postFireExtraExpense:st=0,includePension:B=!1,monthlyInvestment:at=0}=t,rt=c??(r?r/12:0),lt=Math.pow(1+l,1/12)-1,L=Math.pow(1+(_?C:0),1/12)-1,k=(100-m)*12,ct=new Date;let i=e,A=n-e,x=s;const p=o?[]:null,it=k;for(let f=0;f<=it;f++){const G=m+f/12,ut=Math.max(0,k-f),W=tt({baseMonthlyExpense:rt,monthlyInflationRate:L,monthIndex:f,simulationStartDate:ct,mortgageMonthlyPayment:v,mortgagePayoffDate:D}),V=st*Math.pow(1+L,f),$=Math.max(0,A+i),y=x!==-1&&f>=x,mt=x===-1?m+100:m+x/12,H=B?q(G,mt):0,j=y?0:u,O=W+(y?V:0),b=j+H;if(o&&f<=E){const S=X({monthlyExpense:W+V,monthlyReturn:lt,monthlyInflation:L,remainingMonths:ut,taxRate:N,includeTax:R,currentAgeInSimulation:G,includePension:B,withdrawalRate:d});p.push({month:f,age:G,assets:$,riskAssets:i,cashAssets:A,requiredAssets:S,isFire:y,income:j,pension:H,expenses:O,investmentGain:0,withdrawal:0})}if(f===k)break;let P=0,K=0,Y=0;const Mt=h[f];if(y){const S=$*d/12,g=Math.max(0,O-b),U=Math.max(g,S),w=Math.min(A,U),I=U-w,F=Math.max(0,i*(R?1-N:1)),z=Math.min(I,F),J=z/(R?1-N:1);i-=J,i=Math.max(0,i),A+=b+z-O,P=w+J}else{const S=b-O,g=A+S;if(g<0){const U=Math.abs(g),w=Math.max(0,i*(R?1-N:1)),I=Math.min(U,w),F=I/(R?1-N:1);i-=F,i=Math.max(0,i),A=g+I,P=I>0?F:0}else K=Math.min(at,g),A=g-K,i+=K,P=0}if(Y=i*Mt,i+=Y,o&&f<=E){const S=p[p.length-1];S&&(S.investmentGain=Y,S.withdrawal=P)}}const ht=A+i>=0;return{fireReachedMonth:x,monthlyData:p,survived:ht}}function nt(t,o=null){const{currentAge:s=40,maxMonths:h=1200}=t,M=Math.min(h,(100-s)*12);let n=0,e=M,l=-1;for(;n<=e;){const a=Math.floor((n+e)/12)*12;T(t,{fireMonth:a,returnsArray:o}).survived?(l=a,e=a-12):n=a+12}if(l!==-1){let a=Math.max(0,l-11),c=l;for(;a<=c;){const r=Math.floor((a+c)/2);T(t,{fireMonth:r,returnsArray:o}).survived?(l=r,c=r-1):a=r+1}}return l}function et(t,o={}){const{forceFireMonth:s=null,returnsArray:h=null,randomReturn:M=!1,recordMonthly:n=!1}=o;let e=h;if(!e){const{currentAge:a=40,annualReturnRate:c=0,annualStandardDeviation:r=0}=t,u=(100-a)*12,m=Math.pow(1+c,1/12)-1,E=r/Math.sqrt(12);e=[];for(let _=0;_<=u;_++)M?e.push(m+E*Q()):e.push(m)}let l=s;return l===null&&(l=nt(t,e)),T(t,{recordMonthly:n,fireMonth:l,returnsArray:e})}function ot(t){const{currentAge:o=40,maxMonths:s=1200}=t,h=t.iterations??1e3,M=Math.min(s,(100-o)*12),n=[];for(let r=0;r<h;r++){const u=et(t,{randomReturn:!0}),m=u.fireReachedMonth===-1?M:u.fireReachedMonth;n.push(m)}n.sort((r,u)=>r-u);const e=n[Math.floor(n.length/2)],l=n[Math.floor(n.length*.05)],a=n[Math.floor(n.length*.95)],c=n.reduce((r,u)=>r+u,0)/n.length;return{trials:n,stats:{mean:c,median:e,p5:l,p95:a}}}self.onmessage=t=>{const o=t.data;try{const s=ot(o);self.postMessage({type:"success",result:s})}catch(s){self.postMessage({type:"error",error:s.message})}}})();
